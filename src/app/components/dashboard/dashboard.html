<app-carry-forward-dialog *ngIf="showCarryForwardDialog && previousPlan" [previousPlan]="previousPlan"
  (carryForward)="handleCarryForward()" (modify)="handleModifyPlan()">
</app-carry-forward-dialog>

<div class="p-6 w-full xl:max-w-[95%] mx-auto space-y-6">

  <!-- Header: Welcome & Actions -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
    <div>
      <h1 class="text-2xl font-bold text-slate-800">Dashboard</h1>
      <p class="text-slate-500 text-sm">Welcome back to your financial overview</p>
    </div>

    <div class="flex items-center gap-3">
      <!-- Streak Badge -->
      <div
        class="flex items-center gap-2 bg-orange-50 text-orange-600 px-3 py-1.5 rounded-full border border-orange-100 shadow-sm">
        <span class="text-lg">üî•</span>
        <span class="font-bold">{{ streak }} Day Streak</span>
      </div>

      <!-- Points Badge -->
      <div
        class="flex items-center gap-2 bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-full border border-indigo-100 shadow-sm">
        <span class="text-lg">üèÜ</span>
        <span class="font-bold">{{ points }} Pts</span>
      </div>

      <!-- Challenges Button -->
      <button (click)="openChallengesModal()"
        class="flex items-center gap-2 bg-violet-100 hover:bg-violet-200 text-violet-700 px-4 py-2 rounded-lg font-semibold transition-colors shadow-sm">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
        <span>Challenges</span>
      </button>

      <!-- Telegram Button -->
      <button (click)="showTelegramDialog = true"
        class="flex items-center gap-2 bg-[#0088cc] hover:bg-[#0077b5] text-white px-4 py-2 rounded-lg font-semibold transition-colors shadow-sm">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
          <path
            d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z" />
        </svg>
        <span *ngIf="!telegramLinked">Connect Telegram</span>
        <span *ngIf="telegramLinked">Telegram Linked</span>
      </button>
    </div>
  </div>

  <!-- ROW 1: Top Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-6">

    <!-- Income -->
    <div
      class="lg:col-span-2 bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex flex-col justify-between h-36">
      <div class="flex justify-between items-start">
        <div class="p-2 bg-emerald-50 rounded-lg text-emerald-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <span
          class="text-xs font-bold px-2 py-1 bg-emerald-50 text-emerald-600 rounded-full uppercase tracking-wider">Income</span>
      </div>
      <div>
        <p class="text-slate-500 text-xs font-medium mb-1">Total Income</p>
        <p class="text-xl font-bold text-slate-800">‚Çπ{{ totalIncome | number }}</p>
      </div>
    </div>

    <!-- Prediction (New) -->
    <div
      class="lg:col-span-2 bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex flex-col justify-between h-36">
      <div class="flex justify-between items-start">
        <div class="p-2 bg-violet-50 rounded-lg text-violet-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
          </svg>
        </div>
        <span
          class="text-xs font-bold px-2 py-1 bg-violet-50 text-violet-600 rounded-full uppercase tracking-wider">Forecast</span>
      </div>
      <div>
        <p class="text-slate-500 text-xs font-medium mb-1">Next Month Predicted</p>
        <p class="text-xl font-bold text-slate-800">‚Çπ{{ prediction?.predictedAmount || 0 | number }}</p>
      </div>
    </div>

    <!-- Expenses -->
    <div
      class="lg:col-span-3 bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex justify-between items-center h-36">
      <div class="flex flex-col justify-between h-full">
        <div class="flex items-start gap-2">
          <div class="p-2 bg-rose-50 rounded-lg text-rose-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
            </svg>
          </div>
          <span
            class="text-xs font-bold px-2 py-1 bg-rose-50 text-rose-600 rounded-full uppercase tracking-wider">Exp</span>
        </div>
        <div>
          <p class="text-slate-500 text-xs font-medium mb-1">Total Expenses</p>
          <p class="text-2xl font-bold text-slate-800">‚Çπ{{ totalExpense | number }}</p>
          <p class="text-xs text-slate-400">/ ‚Çπ{{ totalPlannedExpense | number }}</p>
        </div>
      </div>
      <!-- Interactive Donut Chart (Expenses Breakdown) -->
      <div class="relative w-24 h-24 flex items-center justify-center">
        <app-pie-chart [data]="expenseChartData" [showLegend]="false" [showTotal]="false"></app-pie-chart>
      </div>
    </div>

    <!-- Balance -->
    <div
      class="lg:col-span-3 bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex justify-between items-center h-36">
      <div class="flex flex-col justify-between h-full">
        <div class="flex items-start gap-2">
          <div class="p-2 bg-blue-50 rounded-lg text-blue-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
          </div>
          <span
            class="text-xs font-bold px-2 py-1 bg-blue-50 text-blue-600 rounded-full uppercase tracking-wider">Balance</span>
        </div>
        <div>
          <p class="text-slate-500 text-xs font-medium mb-1">Current Balance</p>
          <p class="text-2xl font-bold text-slate-800">‚Çπ{{ balance | number }}</p>
        </div>
      </div>
      <!-- Interactive Donut Chart (Unplanned Breakdown) -->
      <div class="relative w-24 h-24 flex items-center justify-center">
        <app-pie-chart [data]="unplannedChartData" [showLegend]="false" [showTotal]="false"></app-pie-chart>
      </div>
    </div>

    <!-- Savings Rate (New) -->
    <div
      class="lg:col-span-2 bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex justify-between items-center h-36">
      <div class="flex flex-col justify-between h-full">
        <div class="flex items-start gap-2">
          <div class="p-2 bg-purple-50 rounded-lg text-purple-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
            </svg>
          </div>
          <span
            class="text-xs font-bold px-2 py-1 bg-purple-50 text-purple-600 rounded-full uppercase tracking-wider">Savings</span>
        </div>
        <div>
          <p class="text-slate-500 text-xs font-medium mb-1">Savings Rate</p>
          <p class="text-2xl font-bold text-slate-800">{{ savingsRate }}%</p>
        </div>
      </div>

      <!-- Trend Indicator -->
      <div class="w-12 h-12 bg-purple-50 rounded-full flex items-center justify-center">
        <svg *ngIf="savingsRateTrend === 'UP'" class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor"
          viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
        </svg>
        <svg *ngIf="savingsRateTrend === 'DOWN'" class="w-6 h-6 text-rose-500" fill="none" stroke="currentColor"
          viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" />
        </svg>
        <svg *ngIf="savingsRateTrend === 'STABLE'" class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor"
          viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14" />
        </svg>
      </div>
    </div>
  </div>

  <!-- ROW 2: Split View (Equal Height Columns) -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-[600px]">

    <!-- LEFT COLUMN -->
    <div class="flex flex-col gap-6 h-full">

      <!-- Budget Overview (Compact) -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 flex-none">
        <div class="flex justify-between items-end mb-2">
          <h2 class="text-lg font-bold text-slate-800">Budget Overview</h2>
          <span class="text-sm font-semibold text-slate-600">{{ totalPlannedExpense > 0 ? ((totalExpense /
            totalPlannedExpense) * 100 | number:'1.1-1') : 0 }}%</span>
        </div>
        <div class="w-full bg-slate-100 rounded-full h-3 mb-2">
          <div class="bg-emerald-500 h-3 rounded-full transition-all duration-500"
            [style.width.%]="totalPlannedExpense > 0 ? (totalExpense / totalPlannedExpense) * 100 : 0"
            [ngClass]="{'bg-emerald-500': (totalExpense / totalPlannedExpense) <= 0.8, 'bg-amber-500': (totalExpense / totalPlannedExpense) > 0.8 && (totalExpense / totalPlannedExpense) <= 1, 'bg-rose-500': (totalExpense / totalPlannedExpense) > 1}">
          </div>
        </div>
        <p class="text-xs text-slate-400">You've spent ‚Çπ{{ totalExpense | number }} out of ‚Çπ{{ totalPlannedExpense |
          number }} this month</p>
      </div>

      <!-- Recent Transactions (Remaining Space) -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 flex flex-col flex-1 overflow-hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold text-slate-800">Recent Transactions</h2>
          <button routerLink="/add-transaction"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold text-sm flex items-center gap-2 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Add
          </button>
        </div>

        <div class="flex-1 overflow-auto custom-scrollbar">
          <table class="w-full text-sm">
            <thead class="bg-slate-50 sticky top-0">
              <tr>
                <th
                  class="text-left py-3 px-4 font-semibold text-slate-500 text-xs uppercase tracking-wider rounded-l-lg">
                  Date</th>
                <th class="text-left py-3 px-4 font-semibold text-slate-500 text-xs uppercase tracking-wider">
                  Description</th>
                <th class="text-left py-3 px-4 font-semibold text-slate-500 text-xs uppercase tracking-wider">Category
                </th>
                <th class="text-left py-3 px-4 font-semibold text-slate-500 text-xs uppercase tracking-wider">Type</th>
                <th
                  class="text-right py-3 px-4 font-semibold text-slate-500 text-xs uppercase tracking-wider rounded-r-lg">
                  Amount</th>
                <th class="text-center py-3 px-4 font-semibold text-slate-500 text-xs uppercase tracking-wider">Actions
                </th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
              <tr *ngFor="let t of recentTransactions" class="hover:bg-slate-50 transition-colors group">
                <td class="py-3 px-4 text-slate-600">{{ t.date }}</td>
                <td class="py-3 px-4 font-medium text-slate-800">{{ t.description }}</td>
                <td class="py-3 px-4">
                  <span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs border border-slate-200">{{
                    t.category?.name }}</span>
                </td>
                <td class="py-3 px-4">
                  <span
                    [ngClass]="t.type === 'INCOME' ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'"
                    class="px-2 py-1 rounded text-xs font-bold uppercase tracking-wide">
                    {{ t.type }}
                  </span>
                </td>
                <td class="py-3 px-4 text-right font-bold"
                  [ngClass]="t.type === 'INCOME' ? 'text-emerald-600' : 'text-rose-600'">
                  {{ t.type === 'INCOME' ? '+' : '-' }}‚Çπ{{ t.amount | number }}
                </td>
                <td class="py-3 px-4 text-center opacity-0 group-hover:opacity-100 transition-opacity">
                  <button (click)="openEditModal(t)" class="text-blue-500 hover:text-blue-700 mr-2"><svg class="w-4 h-4"
                      fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg></button>
                  <button (click)="openDeleteModal(t)" class="text-rose-500 hover:text-rose-700"><svg class="w-4 h-4"
                      fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg></button>
                </td>
              </tr>
            </tbody>
          </table>
          <div *ngIf="transactions.length === 0" class="text-center py-12 text-slate-400">
            No transactions yet. Add one to get started!
          </div>
        </div>
        <div class="mt-4 pt-4 border-t border-slate-100">
          <button routerLink="/transactions"
            class="w-full bg-slate-50 hover:bg-slate-100 text-slate-600 font-semibold py-2 rounded-lg transition-colors text-sm">
            View All Transactions
          </button>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN (Equal Height, Split 50/50) -->
    <div class="flex flex-col gap-6 h-full">

      <!-- Budget vs Actual Chart (Top Half) -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 h-1/2 flex flex-col">
        <h2 class="text-xl font-bold text-slate-800 mb-4">Budget vs Actual</h2>
        <div class="flex-1 relative">
          <canvas baseChart [data]="budgetVsActualChartData" [type]="'bar'" [options]="{
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                            x: { grid: { display: false } }
                        },
                        plugins: {
                            legend: { position: 'top', align: 'end', labels: { usePointStyle: true, boxWidth: 8 } }
                        }
                    }">
          </canvas>
        </div>
        <p class="text-xs text-slate-400 text-center mt-2">* Excluding fixed obligations</p>
      </div>

      <!-- 6-Month Spending Trend (Bottom Half) -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 h-1/2 flex flex-col">
        <h2 class="text-xl font-bold text-slate-800 mb-4">6-Month Spending Trend</h2>
        <div class="flex-1 relative">
          <canvas baseChart [data]="sixMonthTrendChartData" [type]="'line'" [options]="{
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                            x: { grid: { display: false } }
                        },
                        plugins: {
                            legend: { display: false }
                        },
                        elements: {
                            line: { tension: 0.4 }
                        }
                    }">
          </canvas>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Edit Modal -->
<div *ngIf="showEditModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
    <h2 class="text-2xl font-bold text-neutral-text-primary mb-6">Quick Edit Transaction</h2>

    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-neutral-text-secondary mb-2">Description</label>
        <input type="text" [(ngModel)]="editForm.description"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-accent" />
      </div>

      <div>
        <label class="block text-sm font-medium text-neutral-text-secondary mb-2">Amount</label>
        <input type="number" [(ngModel)]="editForm.amount"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-accent" />
      </div>

      <div>
        <label class="block text-sm font-medium text-neutral-text-secondary mb-2">Category</label>
        <input type="text" [(ngModel)]="editForm.categoryName" list="categoryList"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-accent"
          placeholder="Select or type a category" />
        <datalist id="categoryList">
          <option *ngFor="let cat of categories" [value]="cat.name"></option>
        </datalist>
      </div>

      <div>
        <label class="block text-sm font-medium text-neutral-text-secondary mb-2">Date</label>
        <input type="date" [(ngModel)]="editForm.date" [max]="maxDate" [min]="minDate"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-accent" />
      </div>
    </div>



    <div class="flex gap-3 mt-6">
      <button (click)="saveEdit()"
        class="flex-1 bg-brand-accent hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
        Save Changes
      </button>
      <button (click)="closeEditModal()"
        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-semibold transition-colors">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div *ngIf="showDeleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
    <h2 class="text-2xl font-bold text-neutral-text-primary mb-4">Confirm Delete</h2>
    <p class="text-neutral-text-secondary mb-6">
      Are you sure you want to delete this transaction?
    </p>
    <div class="bg-gray-50 p-4 rounded-lg mb-6">
      <p class="text-sm text-neutral-text-secondary">{{ deletingTransaction?.description }}</p>
      <p class="text-lg font-bold mt-2"
        [ngClass]="deletingTransaction?.type === 'INCOME' ? 'text-func-success' : 'text-func-danger'">
        {{ deletingTransaction?.type === 'INCOME' ? '+' : '-' }}‚Çπ{{ deletingTransaction?.amount }}
      </p>
    </div>
    <div class="flex gap-3">
      <button (click)="confirmDelete()"
        class="flex-1 bg-func-danger hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
        Delete
      </button>
      <button (click)="closeDeleteModal()"
        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-semibold transition-colors">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Telegram Link Dialog -->
<app-telegram-link-dialog *ngIf="showTelegramDialog" (closeEvent)="closeTelegramDialog()">
</app-telegram-link-dialog>

<!-- Challenges Widget (Hidden by default, controlled via ViewChild) -->
<app-challenges-widget></app-challenges-widget>